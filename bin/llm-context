#!/usr/bin/env python3

import os
import argparse
from pathlib import Path

import pathspec

def load_gitignore_patterns(base_path):
    patterns = []
    local_gitignore = Path(base_path) / '.gitignore'
    global_gitignore = Path.home() / '.bin' / 'dotfiles' / '.gitignore_global'

    for ignore_file in [local_gitignore, global_gitignore]:
        if ignore_file.is_file():
            with open(ignore_file, 'r') as f:
                patterns.extend(f.readlines())

    return pathspec.PathSpec.from_lines('gitwildmatch', patterns)

def generate_file_structure(base_path, spec):
    lines = []
    for root, dirs, files in os.walk(base_path):
        # Ignore hidden dirs/files and those in .gitignore
        rel_root = os.path.relpath(root, base_path)
        rel_root = '.' if rel_root == '.' else rel_root + '/'

        dirs[:] = [d for d in dirs if not spec.match_file(os.path.join(rel_root, d))]
        files = [f for f in files if not spec.match_file(os.path.join(rel_root, f))]

        level = root.replace(base_path, '').count(os.sep)
        indent = '  ' * level
        lines.append(f"{indent}- `{os.path.basename(root)}/`")

        subindent = '  ' * (level + 1)
        for f in sorted(files):
            lines.append(f"{subindent}- `{f}`")
    return '\n'.join(lines)

def read_summary(base_path):
    summary_path = os.path.join(base_path, 'summary.md')
    if os.path.isfile(summary_path):
        with open(summary_path, 'r', encoding='utf-8') as f:
            return f.read().strip()
    return None

def main():
    parser = argparse.ArgumentParser(description='Generate project file structure markdown for LLM input.')
    parser.add_argument('--file-structure', action='store_true', help='Include file structure markdown')
    parser.add_argument('--summary', action='store_true', help='Include summary.md content if available')

    args = parser.parse_args()
    base_path = os.getcwd()
    output_sections = []

    spec = load_gitignore_patterns(base_path)

    if args.summary:
        summary = read_summary(base_path)
        if summary:
            output_sections.append(summary)
        else:
            output_sections.append('_No summary.md found._')

    if args.file_structure:
        file_structure = generate_file_structure(base_path, spec)
        output_sections.append("### File Structure\n" + file_structure)

    print('\n\n'.join(output_sections))

if __name__ == '__main__':
    main()
